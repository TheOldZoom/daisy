generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model user {
  id               String        @id @default(cuid())
  fmUser           String?
  selfPrefix       String?
  blacklistedSince DateTime?
  timezone         String?
  birthday         String?
  messages         userMessage[]
  globalLevel      globalLevel?
  guildMembers     guildMember[]
  guildLevels      guildLevel[]
}

model userMessage {
  id            String   @id @default(cuid()) // Keep this
  guildId       String
  userId        String
  total         Int      @default(0)
  wordCount     Int      @default(0)
  lastMessageAt DateTime @updatedAt
  user          user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId])
  @@index([userId])
  @@index([guildId])
}

model globalLevel {
  id          Int      @id @default(autoincrement())
  userId      String   @unique
  level       Int      @default(0)
  xp          Int      @default(0)
  lastLevelUp DateTime @default(now())
  rank        Int?
  bonusXP     Int      @default(0)

  user user @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model guild {
  id               String    @id @default(cuid())
  name             String?
  prefix           String?
  blacklistedSince DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime? @updatedAt
  lastSeenAt       DateTime?

  icon     String?
  ownerId  String?
  settings guildSettings?
  levels   guildLevel[]
  members  guildMember[]

  levelingEnabled Boolean @default(true)
  welcomeEnabled  Boolean @default(false)
  automodEnabled  Boolean @default(false)

  systemChannelId  String?
  welcomeChannelId String?
  logsChannelId    String?

  @@index([ownerId])
}

model guildMember {
  id         Int       @id @default(autoincrement())
  guildId    String
  userId     String
  nick       String?
  joinedAt   DateTime  @default(now())
  isMuted    Boolean   @default(false)
  mutedUntil DateTime?

  guild guild             @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user  user              @relation(fields: [userId], references: [id], onDelete: Cascade)
  roles guildMemberRole[]

  @@unique([userId, guildId])
  @@index([guildId])
  @@index([userId])
}

model guildMemberRole {
  id            Int    @id @default(autoincrement())
  roleId        String
  guildMemberId Int

  guildMember guildMember @relation(fields: [guildMemberId], references: [id], onDelete: Cascade)

  @@unique([roleId, guildMemberId])
  @@index([guildMemberId])
}

model guildLevel {
  id          Int      @id @default(autoincrement())
  guildId     String
  userId      String
  level       Int      @default(0)
  xp          Int      @default(0)
  lastLevelUp DateTime @default(now())
  rank        Int?
  bonusXP     Int      @default(0)

  guild guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user  user  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, guildId])
  @@index([guildId])
  @@index([userId])
}

model guildSettings {
  id      Int    @id @default(autoincrement())
  guildId String @unique
  guild   guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  levelUpMessage   String?
  levelUpChannelId String?

  welcomeMessage  String?
  farewordMessage String?
  defaultRoles    guildDefaultRole[]

  antiSpam    Boolean @default(false)
  maxMentions Int     @default(5)
  maxLines    Int     @default(10)

  excludedRoles    guildExcludedRole[]
  excludedChannels guildExcludedChannel[]
  bannedWords      guildBannedWord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model guildDefaultRole {
  id            Int           @id @default(autoincrement())
  roleId        String
  settingsId    Int
  guildSettings guildSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@unique([roleId, settingsId])
  @@index([settingsId])
}

model guildExcludedRole {
  id            Int           @id @default(autoincrement())
  roleId        String
  settingsId    Int
  guildSettings guildSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@unique([roleId, settingsId])
  @@index([settingsId])
}

model guildExcludedChannel {
  id            Int           @id @default(autoincrement())
  channelId     String
  settingsId    Int
  guildSettings guildSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@unique([channelId, settingsId])
  @@index([settingsId])
}

model guildBannedWord {
  id            Int           @id @default(autoincrement())
  word          String
  settingsId    Int
  guildSettings guildSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@unique([word, settingsId])
  @@index([settingsId])
}

model status {
  id   Int     @id @default(autoincrement())
  text String
  type String
  url  String?
}
